meta:
  engine: 4.2.1
  name: chitin
  version: 1.0
  author: Scybin
  url: https://github.com/Scybin/chitin

units:

  # Key Variables (MX)
  kx: u # 19mm spacing between key centers
  ky: u # 19mm spacing between key centers
  kcow: 14 # MX plate cutout width
  kcoh: 14 # MX plate cutout height
  keycw: 18 # keycap width (MX / Cherry ~18 mm)
  keych: 18 # keycap height (MX / Cherry ~18 mm)
  switch_rotation: 180 # Hotswap south, LED north
  pcb_shift: 1 # Padding

  # Diode Variables
  vertical_diode_shift: 1.5 # How much to shift to avoid overlap
  horizontal_diode_shift: -0.5 kcow - 0.85
  diode_rotation: -90 # Diode rotation
  diode_padding_y: 1.5 # Vertical padding between diodes
  diode_downshift_y: 0.25 # Shift paired diodes on y-axis

  # Controller Variables
  mcu_width: 18 # x-axis
  mcu_height: 30.6 # y-axis
  mcu_padding_x: 1.5
  mcu_padding_y: 1

  # Reset Switch Variables
  rst_x: 27.884 # Reset switch position on x-axis
  rst_y: -28.5 # Reset switch position on y-axis

  # On Off Switch Variables
  pwr_x: 27.725 # On off switch position on x-axis
  pwr_y: rst_y-9.35 # On off switch position on y-axis
  pwr_shift: 5 # On off switch footprint center point shift

  # JST-PH Variables
  jst_x: pwr_x-4.5 # JST connector position on x-axis
  jst_y: -34.01 # JST connector position on y-axis
  jst_shift: 3.5 # JST footprint center point shift

  # Screw variables
  screw_hole_M2: 1.1 # M2 screw hole radius
  screw_hole_M2_5: 1.35  # M2.5 screw hole radius

  # Standoff variables
  insert_size: 2.5 # Threaded screw inserts 3.2mm wide, and 3mm tall
  insert_radius: 1.25 # Threaded screw insert radius
  spacer_radius: 2.15 # M2 standoffs
  spacer_diameter: spacer_radius * 2

  # FR4 variables
  fr4_thickness: 1.6  # standard FR4 thickness in mm  

  # Case variables
  case_x: kx+8 # Case position on x-axis
  case_y: ky+8 # Case position on y-axis
  wall_z: 24.3 # Wall height (& cut)
  cover_z: 28.3 # Cover height (& fill)
  lip_z: 12 # Bottom / Inner lip height

  # Trackball variables
  trackball_housing_w: 14 # Square Width
  trackball_housing_h: 14 # Square Height
  trackball_clearance: 0.15 # Padding
  trackball_hole_w: trackball_housing_w + 2*trackball_clearance
  trackball_hole_h: trackball_housing_h + 2*trackball_clearance
  trackball_offset_x: 0.5kx + (mcu_width + mcu_padding_x)/2 - 1.25
  trackball_offset_y: 3.5
  trackball_screw_x: 5.5
  trackball_screw_y: 9.8

points:
  zones:

    # Main key matrix
    matrix:
      key:
        padding: ky
        spread: kx
        tags:
          - key
          - matrix_key
      anchor.shift: [100,-150] # Fix KiCad placement
      columns:
        outer:
          key:
            column_net: C0
        pinky:
          key:
            column_net: C1
            stagger: 0.1ky
        ring:
          key:
            column_net: C2
            stagger: 0.66ky
        middle:
          key:
            column_net: C3
            stagger: 0.25ky
        index:
          key:
            column_net: C4
            stagger: -0.25ky
        inner:
          key:
            column_net: C5
            stagger: -0.15ky
      rows:
        bottom:
          row_net: R3
        home:
          row_net: R2
        upper:
          row_net: R1
        top:
          row_net: R0
          key:
            tags:

    # Thumb cluster
    thumb:
      key:
        padding: ky
        spread: kx
        tags:
          - key
          - thumb_key
      anchor:
        ref: matrix_index_bottom
      columns:
        tuck:
          key:
            column_net: C2
            name: thumb_tuck
            shift: [-1.075kx, -1.24ky]
            rotate: 10
        layer: 
          key:
            column_net: C3
            name: thumb_layer
            shift: [-1kx, -1.15ky]
        space:
          key:
            column_net: C4
            name: thumb_space
            width: 1.5kx
            shift: [-14.5, -1.15ky]
      rows:
        cluster:
          row_net: R4

    # Extra Keys
    extra:
      key:
        padding: ky
        spread: kx
        tags:
          - key
          - extra_key
      anchor:
        ref: matrix_inner_bottom
        shift: [kx, 0]
      columns:
        macro:
          key:
            column_net: C6
      rows:
        bottom:
          row_net: R3
          name: extra_bottom
        home:
          row_net: R2 
          name: extra_top

    # Standoff / screw points:
    mount_outer_upper:
      key.tags:
        - helper
        - mount
      anchor:
        - ref: matrix_outer_upper
          shift: [0.5kx, 0.55ky]
    mount_outer_home:
      key.tags:
        - helper
        - mount
      anchor:
        - ref: matrix_outer_home
          shift: [0.5kx, 0.55ky]
    mount_outer_bottom:
      key.tags:
        - helper
        - mount
      anchor:
        - ref: matrix_outer_bottom
          shift: [0.5kx, 0.55ky]
    mount_middle_bottom:
      key.tags:
        - helper
        - mount
      anchor:
        - ref: matrix_middle_bottom
          shift: [-0.7125, -14.155]
    mount_inner_top:
      key.tags:
        - helper
        - mount
      anchor:
        - ref: matrix_inner_top
          shift: [-0.5kx, -0.5kcow-1.075]          
    mount_inner_middle:
      key.tags:
        - helper
        - mount
      anchor:
        - ref: matrix_inner_upper
          shift: [-0.5kx, -0.5kcow-1.075]                          
    mount_inner_home:
      key.tags:
        - helper
        - mount
      anchor:
        - ref: matrix_inner_home
          shift: [-0.5kx, -0.5kcow-1.075]
    mount_extra_top:
      key.tags:
        - helper
        - mount
      anchor:
        - ref: extra_top
          shift: [-0.5kx, -0.5keych-0.5]   
    mount_extra_bottom:
      key.tags:
        - helper
        - mount
      anchor:
        - ref: extra_bottom
          shift: [-0.5kx, -0.5keych]   

    # Insert Points
    wall_insert_nw:
      key.tags:
        - helper
        - wall_screw
      anchor:
        - ref: matrix_outer_top
          shift: [-0.5keycw, 0.5keych + 2.5 + pcb_shift]
    wall_insert_ne:
      key.tags:
        - helper
        - wall_screw
      anchor:
        - ref: matrix_inner_top
          shift: [0.5kx + mcu_width + mcu_padding_x, 0.5keych + 2.5 + pcb_shift]
    wall_insert_sw:
      key.tags:
        - helper
        - wall_screw
      anchor:
        - ref: matrix_outer_bottom
          shift: [-0.5keycw, -0.5keych - 2.5 - pcb_shift]
    wall_insert_se:
      key.tags:
        - helper
        - wall_screw
      anchor:
        - ref: thumb_space
          shift: [1.5kx/2 + 0.5kx-0.5, -0.5keych - 2.5 - pcb_shift]    

    # Trackball Points
    trackball_center:
      key.tags:
        - helper
        - trackball
      anchor:
        - ref: matrix_inner_home
          shift: [trackball_offset_x, trackball_offset_y]      
    trackball_hole_nw:
      key.tags:
        - helper
        - trackball_screw
      anchor:
        - ref: trackball_center
          shift: [-trackball_screw_x,  trackball_screw_y]
    trackball_hole_ne:
      key.tags:
        - helper
        - trackball_screw
      anchor:
        - ref: trackball_center
          shift: [trackball_screw_x,  trackball_screw_y]
    trackball_hole_sw:
      key.tags:
        - helper
        - trackball_screw
      anchor:
        - ref: trackball_center
          shift: [-trackball_screw_x, -trackball_screw_y]
    trackball_hole_se:
      key.tags:
        - helper
        - trackball_screw
      anchor:
        - ref: trackball_center
          shift: [trackball_screw_x, -trackball_screw_y]                                   

  #mirror: &mirror
  #  ref: matrix_inner_top
  #  distance: 5kx

outlines:

    keycap_outline:
    - what: rectangle
      fillet: 0
      where: /key/
      size: [keycw, keych]
    - what: rectangle
      fillet: 0
      where: thumb_space
      size: [1.5keycw, keych]
      operation: add
    switch_cutout:
    - what: rectangle
      where: /key/
      size: [kcow, kcoh]
    switch_cutout_test:
    - what: rectangle
      where: /key/
      size: [kcow - 1, kcoh - 1]      

    pcb:
    - what: polygon
      operation: stack
      points:
        - ref: matrix_outer_top
          shift: [-0.5keycw - pcb_shift, 0.5keych + pcb_shift]
        - ref: matrix_outer_top
          shift: [0.5kx + 0.5 - pcb_shift, 0.5keych + pcb_shift]
        - ref: matrix_pinky_top
          shift: [-0.5keycw - pcb_shift, 0.5keych + pcb_shift]
        - ref: matrix_pinky_top
          shift: [0.5kx + 0.5 - pcb_shift, 0.5keych + pcb_shift]
        - ref: matrix_ring_top
          shift: [-0.5keycw - pcb_shift, 0.5keych + pcb_shift]
        - ref: matrix_ring_top
          shift: [0.5kx + 0.5 - pcb_shift, 0.5keych + pcb_shift]          
        - ref: matrix_middle_top
          shift: [-0.5keycw - pcb_shift, 0.5keych + pcb_shift]
        - ref: matrix_middle_top
          shift: [0.5keycw + pcb_shift, 0.5keych + pcb_shift]          
        - ref: matrix_index_top
          shift: [-0.5kx - 0.5 + pcb_shift, 0.5keych + pcb_shift]
        - ref: matrix_index_top
          shift: [0.5keycw + pcb_shift, 0.5keych + pcb_shift]          
        - ref: matrix_inner_top
          shift: [-0.5kx - 0.5 + pcb_shift, 0.5keych + pcb_shift]
        - ref: matrix_inner_top
          shift: [0.5kx + mcu_width + mcu_padding_x, 0.5keych + pcb_shift]                        
        - ref: matrix_inner_bottom
          shift: [0.5kx + mcu_width + mcu_padding_x, -0.5keych - ky - pcb_shift]
        - ref: thumb_space
          shift: [-0.5kx, -0.5keych - pcb_shift]
        - ref: thumb_layer
          shift: [-0.5kx, -0.5keych - pcb_shift]
        - ref: thumb_tuck
          shift: [-0.5keycw - 0.158 - pcb_shift, -0.5keych + 0.193 - pcb_shift]
        - ref: matrix_pinky_bottom
          shift: [0.5keycw + pcb_shift, -0.5keych - pcb_shift]
        - ref: matrix_pinky_bottom
          shift: [-0.5kx - 0.5 + pcb_shift, -0.5keych - pcb_shift]          
        - ref: matrix_outer_bottom
          shift: [0.5keycw + pcb_shift, -0.5keych - pcb_shift]
        - ref: matrix_outer_bottom
          shift: [-0.5keycw - pcb_shift, -0.5keych - pcb_shift]  
    pcb_notch_circle:
    - what: circle
      where:
        ref: thumb_space
        shift: [kx, -0.5ky - pcb_shift]
      radius: 3              
    pcb_notched:
    - what: outline
      name: pcb
      operation: stack
    - what: outline
      name: pcb_notch_circle
      operation: subtract   
          
    xlBoard:
    - what: outline
      name: pcb
      expand: 5
      operation: stack
      fillet: 0
    xlBoard_wall:
    - what: outline
      name: xlBoard
    - what: outline
      name: pcb
      operation: subtract
      
    button_access:
    - what: polygon
      points:
        - ref: thumb_tuck
          shift: [10, 20]
        - ref: thumb_tuck
          shift: [-19, -20]
        - ref: matrix_pinky_bottom
          shift: [6.9, -20]
        - ref: matrix_pinky_bottom
          shift: [19.2, 20]
    button_wall:
    - what: outline
      name: button_access
    - what: outline
      name: xlBoard_wall
      operation: intersect    
    usb_access:
    - what: rectangle
      where:
        ref: matrix_inner_top
        shift: [kx, 0.5keych + 1 + pcb_shift]
      size: [14, 8]
    usb_wall:
    - what: outline
      name: usb_access
    - what: outline
      name: xlBoard_wall
      operation: intersect
    trackball_wall_access:
    - what: rectangle
      where:
        ref: trackball_center
        shift: [trackball_housing_w/2 + trackball_clearance + 4, 0]
      size: [10, 17]
    trackball_wall:
    - what: outline
      name: trackball_wall_access
    - what: outline
      name: xlBoard_wall
      operation: intersect

    plate_hole: 
    - what: circle
      radius: screw_hole_M2
      where: /mount/
    standoff_hole: 
    - what: circle
      radius: spacer_radius
      where: /mount/      
    insert:
    - what: circle
      radius: insert_size
      where: /mount/
    wall_insert:
    - what: circle
      radius: insert_radius
      where: /wall_screw/
    wall_clearance:
    - what: circle
      radius: screw_hole_M2
      where: /wall_screw/
    trackball_screw_holes:
    - what: circle
      radius: screw_hole_M2_5
      where: /trackball_screw/

    switchplate:
    - what: polygon
      operation: stack
      points:
        - ref: matrix_outer_top
          shift: [-0.5keycw - pcb_shift, 0.5keych + pcb_shift]
        - ref: matrix_outer_top
          shift: [0.5kx + 0.5 - pcb_shift, 0.5keych + pcb_shift]
        - ref: matrix_pinky_top
          shift: [-0.5keycw - pcb_shift, 0.5keych + pcb_shift]
        - ref: matrix_pinky_top
          shift: [0.5kx + 0.5 - pcb_shift, 0.5keych + pcb_shift]
        - ref: matrix_ring_top
          shift: [-0.5keycw - pcb_shift, 0.5keych + pcb_shift]
        - ref: matrix_ring_top
          shift: [0.5kx + 0.5 - pcb_shift, 0.5keych + pcb_shift]          
        - ref: matrix_middle_top
          shift: [-0.5keycw -  pcb_shift, 0.5keych + pcb_shift]
        - ref: matrix_middle_top
          shift: [0.5keycw + pcb_shift, 0.5keych + pcb_shift]          
        - ref: matrix_index_top
          shift: [-0.5kx - 0.5 + pcb_shift, 0.5keych + pcb_shift]
        - ref: matrix_index_top
          shift: [0.5keycw + pcb_shift, 0.5keych + pcb_shift]          
        - ref: matrix_inner_top
          shift: [-0.5kx - 0.5 + pcb_shift, 0.5keych + pcb_shift]
        - ref: matrix_inner_top
          shift: [0.5keycw, 0.5keych + pcb_shift] 
        - ref: matrix_inner_home
          shift: [0.5keycw, 0.5keych]                       
        - ref: extra_top
          shift: [-0.5keycw, 0.5keych]
        - ref: extra_top
          shift: [0.5keycw + 1, 0.5keych]
        - ref: extra_bottom
          shift: [0.5keycw + 1, -0.5keych]  
        - ref: thumb_space
          shift: [1.5kx/2, 0.5keych + 1]                                                         
        - ref: thumb_space
          shift: [1.5kx/2, -0.5keych - pcb_shift]
        - ref: thumb_space
          shift: [-0.5kx, -0.5keych - pcb_shift]
        - ref: thumb_layer
          shift: [-0.5kx, -0.5keych - pcb_shift]
        - ref: thumb_tuck
          shift: [-0.5keycw - 0.158 - pcb_shift, -0.5keych + 0.193 - pcb_shift]
        - ref: matrix_pinky_bottom
          shift: [0.5keycw + pcb_shift, -0.5keych - pcb_shift]
        - ref: matrix_pinky_bottom
          shift: [-0.5kx - 0.5 + pcb_shift, -0.5keych - pcb_shift]          
        - ref: matrix_outer_bottom
          shift: [0.5keycw + pcb_shift, -0.5keych - pcb_shift]
        - ref: matrix_outer_bottom
          shift: [-0.5keycw - pcb_shift, -0.5keych - pcb_shift]  
    - what: outline
      name: switch_cutout
      operation: subtract
    - what: outline
      name: plate_hole
      operation: subtract          
    switchplate_tb:
    - what: polygon
      operation: stack
      points:
        - ref: matrix_outer_top
          shift: [-0.5keycw - pcb_shift, 0.5keych + pcb_shift]
        - ref: matrix_outer_top
          shift: [0.5kx + 0.5 - pcb_shift, 0.5keych + pcb_shift]
        - ref: matrix_pinky_top
          shift: [-0.5keycw - pcb_shift, 0.5keych + pcb_shift]
        - ref: matrix_pinky_top
          shift: [0.5kx + 0.5 - pcb_shift, 0.5keych + pcb_shift]
        - ref: matrix_ring_top
          shift: [-0.5keycw - pcb_shift, 0.5keych + pcb_shift]
        - ref: matrix_ring_top
          shift: [0.5kx + 0.5 - pcb_shift, 0.5keych + pcb_shift]          
        - ref: matrix_middle_top
          shift: [-0.5keycw - pcb_shift, 0.5keych + pcb_shift]
        - ref: matrix_middle_top
          shift: [0.5keycw + pcb_shift, 0.5keych + pcb_shift]          
        - ref: matrix_index_top
          shift: [-0.5kx - 0.5 + pcb_shift, 0.5keych + pcb_shift]
        - ref: matrix_index_top
          shift: [0.5keycw + pcb_shift, 0.5keych + pcb_shift]          
        - ref: matrix_inner_top
          shift: [-0.5kx - 0.5 + pcb_shift, 0.5keych + pcb_shift]
        - ref: matrix_inner_top
          shift: [0.5keycw, 0.5keych + pcb_shift] 
        - ref: matrix_inner_home
          shift: [0.5keycw, 0.5keych] 
        - ref: extra_bottom
          shift: [-0.5kx - 0.5, 0.5keych]                                          
        - ref: extra_bottom
          shift: [0.5keycw + 1, 0.5keych]    
        - ref: extra_bottom
          shift: [0.5keycw + 1, -0.5keych]            
        - ref: thumb_space
          shift: [1.5kx/2, 0.5keych + 1]                                                         
        - ref: thumb_space
          shift: [1.5kx/2, -0.5keych - pcb_shift]
        - ref: thumb_space
          shift: [-0.5kx, -0.5keych - pcb_shift]
        - ref: thumb_layer
          shift: [-0.5kx, -0.5keych - pcb_shift]
        - ref: thumb_tuck
          shift: [-0.5keycw - 0.158 - pcb_shift, -0.5keych + 0.193 - pcb_shift]
        - ref: matrix_pinky_bottom
          shift: [0.5keycw + pcb_shift, -0.5keych - pcb_shift]
        - ref: matrix_pinky_bottom
          shift: [-0.5kx - 0.5 + pcb_shift, -0.5keych - pcb_shift]          
        - ref: matrix_outer_bottom
          shift: [0.5keycw + pcb_shift, -0.5keych - pcb_shift]
        - ref: matrix_outer_bottom
          shift: [-0.5keycw - pcb_shift, -0.5keych - pcb_shift]  
    - what: outline
      name: switch_cutout
      operation: subtract
    - what: outline
      name: plate_hole
      operation: subtract

    # MCU / Trackball Cover
    cover_nw_corner:
    - what: rectangle
      where:
        ref: matrix_inner_top
        shift: [0.5kx + 3, 0.5keych + 2 + pcb_shift]    
      size: [5, 6]
      fillet: 0 
    cover_se_corner:
    - what: rectangle
      where:
        ref: trackball_center
        shift: [trackball_screw_x + 1, -trackball_screw_y + 18]
      size: [19, 5.4]
      fillet: 0  
    cover_sw_corner:
    - what: rectangle
      where:
        ref: trackball_center
        shift: [-trackball_screw_x + 0.5, -trackball_screw_y + 18]
      size: [6, 5.4]
      fillet: 1                      
    cover:
    - what: polygon
      operation: stack
      points:
        - ref: matrix_inner_top
          shift: [kx - 0.5keycw, 0.5keych + 5 + pcb_shift]     
        - ref: matrix_inner_home
          shift: [kx - 0.5keycw, 0.5keych]      
        - ref: matrix_inner_home
          shift: [0.5kx + mcu_width + mcu_padding_x + 5, 0.5keych]                       
        - ref: matrix_inner_top
          shift: [0.5kx + mcu_width + mcu_padding_x + 5, 0.5keych + 5 + pcb_shift]
      fillet: 5
    - what: outline
      name: cover_nw_corner
      operation: add  
    - what: outline
      name: cover_se_corner
      operation: add  
    - what: outline
      name: cover_sw_corner
      operation: add                  
    cover_tb_nw_corner:
    - what: rectangle
      where:
        ref: matrix_inner_top
        shift: [0.5kx + 3, 0.5keych + 2 + pcb_shift]    
      size: [5, 6]
      fillet: 0    
    cover_tb_se_corner:
    - what: rectangle
      where:
        ref: trackball_center
        shift: [trackball_screw_x, -trackball_screw_y]
      size: [21, 5.4]
      fillet: 0      
    cover_tb_sw_corner:
    - what: rectangle
      where:
        ref: trackball_center
        shift: [-trackball_screw_x, -trackball_screw_y]
      size: [5, 5.4]
      fillet: 1                    
    cover_tb:
    - what: polygon
      operation: stack
      points:
        - ref: matrix_inner_top
          shift: [kx - 0.5keycw, 0.5keych + 5 + pcb_shift]     
        - ref: matrix_inner_home
          shift: [kx - 0.5keycw, -0.5keych]      
        - ref: matrix_inner_home
          shift: [0.5kx + mcu_width + mcu_padding_x + 5, -0.5keych]                       
        - ref: matrix_inner_top
          shift: [0.5kx + mcu_width + mcu_padding_x + 5, 0.5keych + 5 + pcb_shift]
      fillet: 5
    - what: outline
      name: cover_tb_nw_corner
      operation: add         
    - what: outline
      name: cover_tb_se_corner
      operation: add      
    - what: outline
      name: cover_tb_sw_corner
      operation: add
    cover_tb_cut:
    - what: rectangle
      where:
        ref: trackball_center
      size: [trackball_hole_w, trackball_hole_h]
      fillet: 2          

    # Lip to hold PCB
    bottom_lip_rect:
    - what: rectangle
      where:
        ref: thumb_space
        shift: [kx, -9]
      size: [6, 2]
    bottom_lip_rect_raise:
    - what: outline
      name: bottom_lip_rect
      expand: 1
      joints: 1  
    bottom_lip_wall:
    - what: outline
      name: pcb
      joints: 1
    bottom_lip_cut:
    - what: outline
      name: bottom_lip_wall
      expand: -1
      joints: 1
    mcu_lip_clear:
    - what: rectangle
      where:
        ref: matrix_inner_top
        shift: [kx + mcu_width/2 + 1, -8]
      size: [4, mcu_height + mcu_padding_y]

    # Battery housing
    inner_lip:
    - what: polygon
      points:
        - ref: matrix_pinky_top
          shift: [10, 0.5keych + pcb_shift]
        - ref: matrix_pinky_top
          shift: [9, 0.5keych + pcb_shift]
        - ref: matrix_pinky_bottom
          shift: [9, -0.5keych - pcb_shift]
        - ref: matrix_pinky_bottom
          shift: [10, -0.5keych - pcb_shift]
    - what: polygon
      points:
        - ref: matrix_index_top
          shift: [-10, 0.5keych + pcb_shift]
        - ref: matrix_index_top
          shift: [-9, 0.5keych + pcb_shift]
        - ref: matrix_index_home
          shift: [-9, -0.5keych - 3.5 - pcb_shift]
        - ref: matrix_index_home
          shift: [-10, -0.5keych - 3.5 - pcb_shift]
    - what: polygon
      points:
        - ref: matrix_index_home
          shift: [-9, -0.5keych - 7.5 - pcb_shift]
        - ref: matrix_index_home
          shift: [-10, -0.5keych - 7.5 - pcb_shift]
        - ref: thumb_layer
          shift: [-10, -0.5keych - pcb_shift]
        - ref: thumb_layer
          shift: [-9, -0.5keych - pcb_shift]

    _combo:
    - what: outline
      name: pcb
    - operation: subtract
      name: keycap_outline
    - operation: stack
      name: standoff_hole
    - what: outline
      name: inner_lip
      operation: stack     

pcbs:
  chitin:
    template: kicad8
    outlines:
      main:
        outline: pcb_notched
      #keycaps_front:
      #    outline: keycap_outline
      #    layer: F.SilkS
      #switches_front:
      #    outline: switch_cutout
      #    layer: F.SilkS

    footprints:

      key_switches:
        what: ceoloide/switch_mx
        where: /key/
        params:
          from: "{{column_net}}"
          to: "{{colrow}}_B"
          reversible: true
        adjust:
          rotate: switch_rotation

      diodes_b:
        what: ceoloide/diode_tht_sod123
        where: /key/
        params:
          from: "{{colrow}}_B"
          to: "{{row_net}}"
          reversible: false
          side: B
        adjust:
          shift: [horizontal_diode_shift, vertical_diode_shift]
          rotate: diode_rotation  
          
      diodes_f:
        what: ceoloide/diode_tht_sod123
        where: /key/
        params:
          from: "{{colrow}}_B"
          to: "{{row_net}}"
          reversible: false
          side: F
        adjust:
          shift: [-1 * horizontal_diode_shift, vertical_diode_shift]
          rotate: diode_rotation 
          
      mcu:
        what: scybin/mcu_nice_nano_sp # 8.5mm pcb through-holes
        where:
          ref: matrix_inner_top
          shift: [kx, -mcu_width/2 + 1.4 + pcb_shift]
        params:
          reversible: true
          use_rectangular_jumpers: true
          show_instructions: false

          #Pin Assignments

          # Left side
          # RAW:         # Battery Pos
          # GND:         # Ground / Battery Neg
          # RST:         # Reset pin
          VCC: V+
          P21: C0
          P20: C1
          P19: C2
          P18: C3
          P15: C4
          P14: C5
          P16: C6
          # P10:        # Free pin, not used

          #Right side
          # P1:         # Free pin, not used
          # P0:         # Free pin, not used
          # GND:
          # GND:
          P2: SDA
          P3: SCL
          # P4:         # Free pin, not used
          P5: R0
          P6: R1
          P7: R2
          P8: R3
          P9: R4

      on_off_switch:
        what: ceoloide/power_switch_smd_side
        where: matrix_pinky_bottom
        params:
          from: BAT_P
          to: RAW
          reversible: true
        adjust:
          shift: [0.5kx + pwr_shift + 2jst_shift + 1.5, -16.2]
          rotate: -124

      reset_switch:
        what: scybin/reset_switch_smd_side
        where: matrix_pinky_bottom
        params:
          from: GND
          to: RST
          reversible: true
          include_bosses: true
        adjust:
          shift: [0.5kx + jst_shift + 2.25, -11]  
          rotate: 146
          
      jst_ph:  
        what: ceoloide/battery_connector_jst_ph_2
        where: thumb_space
        params:
          BAT_P: BAT_P
          BAT_N: GND
          reversible: true
          include_courtyard: false
        adjust:
          shift: [kx, 0.5ky-2]

      jst_sh:  
        what: scybin/jst_sh_sm04b_srss_tb
        where: matrix_inner_home
        params:
          GND: GND
          VCC: V+
          SDA: SDA
          SCL: SCL
          reversible: true
        adjust:
          shift: [kx, 10.3]   
      
      logo:
        what: ceoloide/utility_ergogen_logo
        where: matrix_pinky_bottom
        adjust:
          shift: [kx, -3]

      mounting_holes:
        what: ceoloide/mounting_hole_npth
        where: /mount/
        params:
          hole_size: spacer_diameter
          hole_drill: spacer_diameter

cases:

  _inserts:
    - name: insert
      extrude: 0     
  _switch_holes:
    - name: switch_cutout  
      extrude: fr4_thickness
  _switch_holes_test:
    - name: switch_cutout_test 
      extrude: fr4_thickness      
  _plate_holes:
    - name: plate_hole 
      extrude: 2
  _mounting_holes:
    - name: standoff_hole
      extrude: fr4_thickness      
  _outerWall:
    - name: xlBoard
      extrude: wall_z
  _innerWall:
    - name: pcb
      extrude: wall_z
  _usb_access_cut:
    - name: usb_wall
      extrude: 22.3
  _usb_access_fill:
    - name: usb_wall
      extrude: 13
  _button_access_cut:
    - name: button_wall
      extrude: wall_z
  _button_access_fill:
    - name: button_wall
      extrude: lip_z
  _trackball_wall_cut:
    - name: trackball_wall
      extrude: wall_z
  _trackball_wall_fill:
    - name: trackball_wall
      extrude: wall_z - 7 
  _switchplate:
    - name: switchplate
      extrude: fr4_thickness
  _switchplate_tb:
    - name: switchplate_tb
      extrude: fr4_thickness   
  _cover_cap:
    - name: cover
      extrude: cover_z
    - name: cover
      extrude: wall_z
      operation: subtract          
  _cover_cap_tb:
    - name: cover_tb
      extrude: cover_z
    - name: cover_tb
      extrude: wall_z
      operation: subtract
    - name: cover_tb_cut
      extrude: cover_z
      operation: subtract  
    - name: trackball_screw_holes
      extrude: cover_z
      operation: subtract          
  _wall_insert:
    - name: wall_insert
      extrude: 3  # 3mm insert height
  _base_holes:
    - name: wall_clearance
      extrude: 2  # through 2 mm bottom plate
  _bottom_lip_notch:
    - name: bottom_lip_rect
      extrude: lip_z   
  _bottom_lip_notch_raise:
    - name: bottom_lip_rect
      extrude: 2  
  _mcu_lip_wall_clear:
    - name: mcu_lip_clear
      extrude: lip_z   
  _inner_lip:
    - name: inner_lip
      extrude: lip_z        

  bottom_case:
    - name: bottom_lip_wall
      extrude: lip_z
    - name: bottom_lip_cut
      extrude: lip_z
      operation: subtract
    - what: case
      name: _mcu_lip_wall_clear
      operation: subtract          
    - name: xlBoard
      extrude: 2
      operation: add 
    - what: case
      name: _bottom_lip_notch
      operation: subtract   
    - what: case
      name: _bottom_lip_notch_raise
      operation: add     
    - what: case
      name: _inner_lip
      operation: add                        
    - what: case
      name: _plate_holes
      operation: subtract
    - what: case
      name: _base_holes
      operation: subtract   

  wall_cover_case_L:
    - what: case
      name: _outerWall
      operation: add
    - what: case
      name: _innerWall
      operation: subtract
    - what: case
      name: _usb_access_cut
      operation: subtract
    - what: case
      name: _usb_access_fill
      operation: add
    - what: case
      name: _button_access_cut
      operation: subtract     
    - what: case
      name: _button_access_fill
      operation: add          
    - what: case
      name: _cover_cap
      operation: add 
    - what: case
      name: _wall_insert
      operation: subtract             
  wall_cover_case_tb_L:
    - what: case
      name: _outerWall
      operation: add
    - what: case
      name: _innerWall
      operation: subtract
    - what: case
      name: _usb_access_cut
      operation: subtract
    - what: case
      name: _usb_access_fill
      operation: add
    - what: case
      name: _button_access_cut
      operation: subtract     
    - what: case
      name: _button_access_fill
      operation: add   
    - what: case
      name: _trackball_wall_cut
      operation: subtract
    - what: case
      name: _trackball_wall_fill
      operation: add          
    - what: case
      name: _cover_cap_tb
      operation: add 
    - what: case
      name: _wall_insert
      operation: subtract             

  switchplate_case:
    - what: case
      name: _switchplate
      operation: add
    - what: case
      name: _switch_holes
      operation: subtract
    - what: case
      name: _plate_holes
      operation: subtract
  switchplate_case_tb:
    - what: case
      name: _switchplate_tb
      operation: add
    - what: case
      name: _switch_holes
      operation: subtract
    - what: case
      name: _plate_holes
      operation: subtract  

  pcb_case:
    - name: pcb_notched
      extrude: fr4_thickness
    - what: case
      name: _switch_holes_test
      operation: subtract
    - what: case
      name: _mounting_holes
      operation: subtract

  full_case:
    - what: case
      name: wall_cover_case_tb_L
      operation: add    
    - what: case
      name: bottom_case
      operation: add       
