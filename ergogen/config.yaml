meta:
  engine: 4.2.1
  name: scyline
  version: 1.0
  author: Scybin
  url: https://github.com/Scybin/scyline

units:

  # Key Variables (MX)
  kx: u # spacing between key centers
  ky: u # spacing between key centers
  px: kx + 2 # horizontal padding (21 mm)
  py: ky + 2 # vertical padding (21 mm)
  ks: 19 # horizontal space between columns (MX default: 19)
  kp: 19 # vertical padding between keys (MX default: 19)
  kcow: 14 # MX plate cutout width
  kcoh: 14 # MX plate cutout height
  keycw: 18 # keycap width (MX / Cherry ~18 mm)
  keych: 18 # keycap height (MX / Cherry ~18 mm)
  switch_rotation: 180 # Hotswap south, LED north

  # Diode Variables
  vertical_diode_shift: 1.5 # How much to shift to avoid overlap
  horizontal_diode_shift: -0.5 kcow - 0.85
  diode_rotation: -180 # Diode rotation

  # Controller Variables
  mcu_width: 18 # x-axis
  mcu_height: 33 # y-axis
  mcu_padding_x: 1.5
  mcu_padding_y: 1

  # Reset Switch Variables
  rst_x: 27.884 # Reset switch position on x-axis
  rst_y: -28.5 # Reset switch position on y-axis

  # On Off Switch Variables
  pwr_x: 27.725 # On off switch position on x-axis
  pwr_y: rst_y-9.35 # On off switch position on y-axis
  pwr_shift: 5 # On off switch footprint center point shift

  # JST-PH Variables
  jst_x: pwr_x-4.5 # JST connector position on x-axis
  jst_y: -34.01 # JST connector position on y-axis
  jst_shift: 3.5 # JST footprint center point shift

  # Screw variables
  screw_size: 1.5 # M2 flathead screw
  screw_x: (-kx/2) # Screw position on x-axis
  screw_y: (-ky/2) # Screw position on y-axis
  screw_hole: 1.1 # Switchplate screw hole radius

  # Standoff variables
  insert_size: 2.5 # Threaded screw inserts 3.2mm wide, and 3mm tall
  insert_radius: 1.25 # Threaded screw insert radius
  spacer_radius: 2.15 # M2 standoffs
  spacer_diameter: spacer_radius * 2

  # Case variables
  case_x: kx+8 # Case position on x-axis
  case_y: ky+8 # Case position on y-axis

points:
  zones:

    # Main key matrix
    matrix:
      key:
        padding: ky
        spread: kx
        tags:
          - key
          - matrix_key
      anchor.shift: [100,-150] # Fix KiCad placement
      columns:
        outer:
          key:
            column_net: C0
        pinky:
          key:
            column_net: C1
            stagger: 0.1ky
        ring:
          key:
            column_net: C2
            stagger: 0.66ky
        middle:
          key:
            column_net: C3
            stagger: 0.25ky
        index:
          key:
            column_net: C4
            stagger: -0.25ky
        inner:
          key:
            column_net: C5
            stagger: -0.15ky
      rows:
        bottom:
          row_net: R3
        home:
          row_net: R2
        upper:
          row_net: R1
        top:
          row_net: R0

    # Thumb cluster
    thumb:
      key:
        padding: ky
        spread: kx
        tags:
          - key
          - thumb_key
      anchor:
        ref: matrix_index_bottom
      columns:
        tuck:
          key:
            column_net: C2
            name: thumb_tuck
            shift: [-1.075kx, -1.24ky]
            rotate: 10
        layer: 
          key:
            column_net: C3
            name: thumb_layer
            shift: [-1kx, -1.15ky]
        space:
          key:
            column_net: C4
            name: thumb_space
            width: 1.5kx
            shift: [-14.5, -1.15ky]
      rows:
        cluster:
          row_net: R4

    # Extra Keys
    extra:
      key:
        padding: ky
        spread: kx
        tags:
          - key
          - extra_key
      anchor:
        ref: matrix_inner_bottom
        shift: [kx, 0]
      columns:
        macro:
          key:
            column_net: C6
      rows:
        bottom:
          row_net: R3
          name: extra_bottom
        home:
          row_net: R2 
          name: extra_top   

    # Standoff / screw points:
    mount_outer_upper:
      key.tags:
        - helper
        - mount
      anchor:
        - ref: matrix_outer_upper
          shift: [0.5kx, 0.55ky]
    mount_outer_home:
      key.tags:
        - helper
        - mount
      anchor:
        - ref: matrix_outer_home
          shift: [0.5kx, 0.55ky]
    mount_outer_bottom:
      key.tags:
        - helper
        - mount
      anchor:
        - ref: matrix_outer_bottom
          shift: [0.5kx, 0.55ky]
    mount_middle_bottom:
      key.tags:
        - helper
        - mount
      anchor:
        - ref: matrix_middle_bottom
          shift: [-0.7125, -14.155]
    mount_inner_top:
      key.tags:
        - helper
        - mount
      anchor:
        - ref: matrix_inner_top
          shift: [-0.5kx, -0.5kcow-1.075]          
    mount_inner_middle:
      key.tags:
        - helper
        - mount
      anchor:
        - ref: matrix_inner_upper
          shift: [-0.5kx, -0.5kcow-1.075]                          
    mount_inner_home:
      key.tags:
        - helper
        - mount
      anchor:
        - ref: matrix_inner_home
          shift: [-0.5kx, -0.5kcow-1.075]
    mount_extra_top:
      key.tags:
        - helper
        - mount
      anchor:
        - ref: extra_top
          shift: [-0.5kx, -0.5keych-0.5]   
    mount_extra_bottom:
      key.tags:
        - helper
        - mount
      anchor:
        - ref: extra_bottom
          shift: [-0.5kx, -0.5keych]   

    # Insert Points
    wall_insert_nw:
      key.tags:
        - helper
        - wall_screw
      anchor:
        - ref: matrix_outer_top
          shift: [-0.5keycw, 0.5keych + 2]
    wall_insert_ne:
      key.tags:
        - helper
        - wall_screw
      anchor:
        - ref: matrix_inner_top
          shift: [0.5kx + mcu_width + mcu_padding_x, 0.5keych + 2]
    wall_insert_sw:
      key.tags:
        - helper
        - wall_screw
      anchor:
        - ref: matrix_outer_bottom
          shift: [-0.5keycw, -0.5keych - 2]
    wall_insert_se:
      key.tags:
        - helper
        - wall_screw
      anchor:
        - ref: thumb_space
          shift: [1.5kx/2 + 0.5kx-0.5, -0.5keych - 2]                           

  #mirror: &mirror
  #  ref: matrix_inner_top
  #  distance: 5kx

outlines:

    keycap_outline:
    - what: rectangle
      fillet: 0
      where: /key/
      size: [keycw, keych]
    - what: rectangle
      fillet: 0
      where: thumb_space
      size: [1.5keycw, keych]
      operation: add
    switch_cutout:
    - what: rectangle
      where: /key/
      size: [kcow, kcoh]

    pcb:
    - what: polygon
      operation: stack
      points:
        - ref: matrix_outer_top
          shift: [-0.5keycw, 0.5keych]
        - ref: matrix_outer_top
          shift: [0.5kx+0.5, 0.5keych]
        - ref: matrix_pinky_top
          shift: [-0.5keycw, 0.5keych]
        - ref: matrix_pinky_top
          shift: [0.5kx+0.5, 0.5keych]
        - ref: matrix_ring_top
          shift: [-0.5keycw, 0.5keych]
        - ref: matrix_ring_top
          shift: [0.5kx+0.5, 0.5keych]          
        - ref: matrix_middle_top
          shift: [-0.5keycw, 0.5keych]
        - ref: matrix_middle_top
          shift: [0.5keycw, 0.5keych]          
        - ref: matrix_index_top
          shift: [-0.5kx-0.5, 0.5keych]
        - ref: matrix_index_top
          shift: [0.5keycw, 0.5keych]          
        - ref: matrix_inner_top
          shift: [-0.5kx-0.5, 0.5keych]
        - ref: matrix_inner_top
          shift: [0.5kx + mcu_width + mcu_padding_x, 0.5keych]                        
        - ref: matrix_inner_bottom
          shift: [0.5kx + mcu_width + mcu_padding_x, -0.5keych-ky]
        - ref: thumb_space
          shift: [-0.5kx, -0.5keych]
        - ref: thumb_layer
          shift: [-0.5kx, -0.5keych]
        - ref: thumb_tuck
          shift: [-0.5keycw, -0.5keych]
        - ref: matrix_pinky_bottom
          shift: [0.5keycw, -0.5keych]
        - ref: matrix_pinky_bottom
          shift: [-0.5kx-0.5, -0.5keych]          
        - ref: matrix_outer_bottom
          shift: [0.5keycw, -0.5keych]
        - ref: matrix_outer_bottom
          shift: [-0.5keycw, -0.5keych]  
    pcb_notched:
    - what: outline
      name: pcb
      operation: stack
    - what: circle
      where:
        ref: thumb_space
        shift: [kx, -0.5ky]
      radius: 2
      operation: subtract     
          
    xlBoard:
    - what: outline
      name: pcb
      expand: 4
      operation: stack
      fillet: 0
    xlBoard_wall:
    - what: outline
      name: xlBoard
    - what: outline
      name: pcb
      operation: subtract
      
    button_access:
    - what: polygon
      points:
        - ref: thumb_tuck
          shift: [0, 20]
        - ref: thumb_tuck
          shift: [-19.5, -20]
        - ref: matrix_pinky_bottom
          shift: [12.5, -20]
        - ref: matrix_pinky_bottom
          shift: [0, 20]
    button_wall:
    - what: outline
      name: button_access
    - what: outline
      name: xlBoard_wall
      operation: intersect    
    usb_access:
    - what: rectangle
      where:
        ref: matrix_inner_top
        shift: [kx, 0.5keych + 1]
      size: [14, 8]
      fillet: 0
    usb_wall:
    - what: outline
      name: usb_access
    - what: outline
      name: xlBoard_wall
      operation: intersect

    mounting: 
    - what: circle
      radius: screw_size
      where: /mount/
    plate_hole: 
    - what: circle
      radius: screw_hole
      where: /mount/
    insert:
    - what: circle
      radius: insert_size
      where: /mount/
    wall_insert:
    - what: circle
      radius: insert_radius
      where: /wall_screw/
    wall_clearance:
    - what: circle
      radius: screw_hole
      where: /wall_screw/

    switchplate:
    - what: polygon
      operation: stack
      points:
        - ref: matrix_outer_top
          shift: [-0.5keycw, 0.5keych]
        - ref: matrix_outer_top
          shift: [0.5kx+0.5, 0.5keych]
        - ref: matrix_pinky_top
          shift: [-0.5keycw, 0.5keych]
        - ref: matrix_pinky_top
          shift: [0.5kx+0.5, 0.5keych]
        - ref: matrix_ring_top
          shift: [-0.5keycw, 0.5keych]
        - ref: matrix_ring_top
          shift: [0.5kx+0.5, 0.5keych]          
        - ref: matrix_middle_top
          shift: [-0.5keycw, 0.5keych]
        - ref: matrix_middle_top
          shift: [0.5keycw, 0.5keych]          
        - ref: matrix_index_top
          shift: [-0.5kx-0.5, 0.5keych]
        - ref: matrix_index_top
          shift: [0.5keycw, 0.5keych]          
        - ref: matrix_inner_top
          shift: [-0.5kx-0.5, 0.5keych]
        - ref: matrix_inner_top
          shift: [0.5keycw, 0.5keych] 
        - ref: matrix_inner_home
          shift: [0.5keycw, 0.5keych]                       
        - ref: extra_top
          shift: [-0.5keycw, 0.5keych]
        - ref: extra_top
          shift: [0.5keycw, 0.5keych]          
        - ref: extra_bottom
          shift: [0.5keycw, 0.5keych]  
        - ref: extra_bottom
          shift: [0.5keycw, 0.5keych]                                           
        - ref: thumb_space
          shift: [1.5kx/2 + 0.5kx-0.5, -0.5keych]
        - ref: thumb_space
          shift: [-0.5kx, -0.5keych]
        - ref: thumb_layer
          shift: [-0.5kx, -0.5keych]
        - ref: thumb_tuck
          shift: [-0.5keycw, -0.5keych]
        - ref: matrix_pinky_bottom
          shift: [0.5keycw, -0.5keych]
        - ref: matrix_pinky_bottom
          shift: [-0.5kx-0.5, -0.5keych]          
        - ref: matrix_outer_bottom
          shift: [0.5keycw, -0.5keych]
        - ref: matrix_outer_bottom
          shift: [-0.5keycw, -0.5keych]  
    switchplate_tb:
    - what: polygon
      operation: stack
      points:
        - ref: matrix_outer_top
          shift: [-0.5keycw, 0.5keych]
        - ref: matrix_outer_top
          shift: [0.5kx+0.5, 0.5keych]
        - ref: matrix_pinky_top
          shift: [-0.5keycw, 0.5keych]
        - ref: matrix_pinky_top
          shift: [0.5kx+0.5, 0.5keych]
        - ref: matrix_ring_top
          shift: [-0.5keycw, 0.5keych]
        - ref: matrix_ring_top
          shift: [0.5kx+0.5, 0.5keych]          
        - ref: matrix_middle_top
          shift: [-0.5keycw, 0.5keych]
        - ref: matrix_middle_top
          shift: [0.5keycw, 0.5keych]          
        - ref: matrix_index_top
          shift: [-0.5kx-0.5, 0.5keych]
        - ref: matrix_index_top
          shift: [0.5keycw, 0.5keych]          
        - ref: matrix_inner_top
          shift: [-0.5kx-0.5, 0.5keych]
        - ref: matrix_inner_top
          shift: [0.5keycw, 0.5keych] 
        - ref: matrix_inner_home
          shift: [0.5keycw, 0.5keych] 
        - ref: extra_bottom
          shift: [-0.5kx-0.5, 0.5keych]                                          
        - ref: extra_bottom
          shift: [0.5keycw, 0.5keych]                                           
        - ref: thumb_space
          shift: [1.5kx/2 + 0.5kx-0.5, -0.5keych]
        - ref: thumb_space
          shift: [-0.5kx, -0.5keych]
        - ref: thumb_layer
          shift: [-0.5kx, -0.5keych]
        - ref: thumb_tuck
          shift: [-0.5keycw, -0.5keych]
        - ref: matrix_pinky_bottom
          shift: [0.5keycw, -0.5keych]
        - ref: matrix_pinky_bottom
          shift: [-0.5kx-0.5, -0.5keych]          
        - ref: matrix_outer_bottom
          shift: [0.5keycw, -0.5keych]
        - ref: matrix_outer_bottom
          shift: [-0.5keycw, -0.5keych]  
    - what: outline
      name: switch_cutout
      operation: subtract
    - what: outline
      name: plate_hole
      operation: subtract

    cover:
    - what: polygon
      operation: stack
      points:
        - ref: matrix_inner_top
          shift: [0.5keycw, 0.5keych+4]     
        - ref: matrix_inner_home
          shift: [0.5keycw, 0.5keych]      
        - ref: matrix_inner_home
          shift: [0.5kx + mcu_width + mcu_padding_x+4, 0.5keych]                       
        - ref: matrix_inner_top
          shift: [0.5kx + mcu_width + mcu_padding_x+4, 0.5keych+4]
      fillet: 4      

    cover_tb:
    - what: polygon
      operation: stack
      points:
        - ref: matrix_inner_top
          shift: [0.5keycw, 0.5keych+4]     
        - ref: matrix_inner_home
          shift: [0.5keycw, -0.5keych]      
        - ref: matrix_inner_home
          shift: [0.5kx + mcu_width + mcu_padding_x+4, -0.5keych]                       
        - ref: matrix_inner_top
          shift: [0.5kx + mcu_width + mcu_padding_x+4, 0.5keych+4]
      fillet: 4

    #combo:
    #- what: outline
    #  name: pcb
    #- what: outline
    #  name: switchplate
    #- operation: subtract
    #  name: keycap_outline
    #- operation: subtract
    #  name: plate_hole
    #- operation: stack
    #  name: switchplate

pcbs:
  scyline_mx:
    template: kicad8
    outlines:
      main:
        outline: pcb_notched
      keycaps_front:
          outline: keycap_outline
          layer: F.SilkS
      switches_front:
          outline: switch_cutout
          layer: F.SilkS

    footprints:

      key_switches:
        what: ceoloide/switch_mx
        where: /key/
        params:
          from: "{{column_net}}"
          to: "{{colrow}}_B"
          reversible: true
        adjust:
          rotate: switch_rotation

      diodes_b:
        what: ceoloide/diode_tht_sod123
        where: /key/
        params:
          from: "{{colrow}}_B"
          to: "{{row_net}}"
          reversible: false
          side: B
        adjust:
          shift: [horizontal_diode_shift, vertical_diode_shift]
          rotate: 90 + diode_rotation  
          
      diodes_f:
        what: ceoloide/diode_tht_sod123
        where: /key/
        params:
          from: "{{colrow}}_B"
          to: "{{row_net}}"
          reversible: false
          side: F
        adjust:
          shift: [-1 * horizontal_diode_shift, vertical_diode_shift]
          rotate: 90 + diode_rotation   
          
      mcu:
        what: scybin/mcu_nice_nano_sp # 8.5mm pcb through-holes
        where:
          ref: matrix_inner_top
          shift: [kx, -mcu_width/2 + 1.4]
        params:
          reversible: true
          use_rectangular_jumpers: true
          show_instructions: false

          #Pin Assignments

          # Left side
          # RAW:         # Battery Pos
          # GND:         # Ground / Battery Neg
          # RST:         # Reset pin
          VCC: 3V3
          P21: C0
          P20: C1
          P19: C2
          P18: C3
          P15: C4
          P14: C5
          P16: C6
          # P10:        # Free pin, not used

          #Right side
          # P1:         # Free pin, not used
          # P0:         # Free pin, not used
          # GND:
          # GND:
          P2: SDA
          P3: SCL
          # P4:         # Free pin, not used
          P5: R0
          P6: R1
          P7: R2
          P8: R3
          P9: R4

      on_off_switch:
        what: ceoloide/power_switch_smd_side
        where: matrix_pinky_bottom
        params:
          from: BAT_P
          to: RAW
          reversible: true
        adjust:
          shift: [0.5kx + pwr_shift + 2jst_shift + 1, -14.8]
          rotate: -122.2

      reset_switch:
        what: ceoloide/reset_switch_smd_side
        where: matrix_pinky_bottom
        params:
          from: GND
          to: RST
          reversible: true
          include_bosses: true
        adjust:
          shift: [0.5kx + jst_shift + 1, -9.6]  
          rotate: 148.2
          
      jst_ph:  
        what: ceoloide/battery_connector_jst_ph_2
        where: thumb_space
        params:
          BAT_P: BAT_P
          BAT_N: GND
          reversible: true
          include_courtyard: false
        adjust:
          shift: [kx, 0.5ky-2]

      jst_sh:  
        what: scybin/jst_sh_sm04b_srss_tb
        where: matrix_inner_home
        params:
          GND: GND
          VCC: 3V3
          SDA: SDA
          SCL: SCL
          reversible: true
        adjust:
          shift: [kx, 0.5kcoh]           
      
      logo:
        what: ceoloide/utility_ergogen_logo
        where: matrix_pinky_bottom
        adjust:
          shift: [kx, -3]

      mounting_holes:
        what: ceoloide/mounting_hole_npth
        where: /mount/
        params:
          hole_size: spacer_diameter
          hole_drill: spacer_diameter

cases:

  _inserts:
    - name: insert
      extrude: 0     
  _switch_holes:
    - name: switch_cutout   
  _plate_holes:
    - name: plate_hole   
  _outerWall:
    - name: xlBoard
      extrude: 18
  _innerWall:
    - name: pcb
      extrude: 18
  _usb_access_cut:
    - name: usb_wall
      extrude: 17
  _usb_access_fill:
    - name: usb_wall
      extrude: 10
  _button_access_cut:
    - name: button_wall
      extrude: 12
  _button_access_fill:
    - name: button_wall
      extrude: 9.5       
  _switchplate:
    - name: switchplate
      extrude: 1.6
  _switchplate_tb:
    - name: switchplate_tb
      extrude: 1.6    
  _cover_cap:
    - name: cover
      extrude: 20
    - name: cover
      extrude: 17
      operation: subtract       
  _cover_cap_tb:
    - name: cover_tb
      extrude: 20
    - name: cover_tb
      extrude: 17
      operation: subtract
  _wall_insert:
    - name: wall_insert
      extrude: 3  # 3mm insert height
  _base_holes:
    - name: wall_clearance
      extrude: 2  # through 2 mm bottom plate

  bottom_case:
    - name: xlBoard
      extrude: 2
    - what: case
      name: _plate_holes
      operation: subtract
    - what: case
      name: _base_holes
      operation: subtract  

  wall_cover_case_L:
    - what: case
      name: _outerWall
      operation: add
    - what: case
      name: _innerWall
      operation: subtract
    - what: case
      name: _usb_access_cut
      operation: subtract
    - what: case
      name: _usb_access_fill
      operation: add
    - what: case
      name: _button_access_cut
      operation: subtract     
    - what: case
      name: _button_access_fill
      operation: add       
    - what: case
      name: _cover_cap
      operation: add 
    - what: case
      name: _wall_insert
      operation: subtract             
  wall_cover_case_tb_L:
    - what: case
      name: _outerWall
      operation: add
    - what: case
      name: _innerWall
      operation: subtract
    - what: case
      name: _usb_access_cut
      operation: subtract
    - what: case
      name: _usb_access_fill
      operation: add
    - what: case
      name: _button_access_cut
      operation: subtract     
    - what: case
      name: _button_access_fill
      operation: add       
    - what: case
      name: _cover_cap_tb
      operation: add 
    - what: case
      name: _wall_insert
      operation: subtract             

  switchplate_case:
    - what: case
      name: _switchplate
      operation: add
    - what: case
      name: _switch_holes
      operation: subtract
    - what: case
      name: _plate_holes
      operation: subtract
  switchplate_case_tb:
    - what: case
      name: _switchplate_tb
      operation: add
    - what: case
      name: _switch_holes
      operation: subtract
    - what: case
      name: _plate_holes
      operation: subtract   

  #full_case:
  #  - what: case
  #    name: xlBottom
  #    operation: add
  #  - what: case
  #    name: wall
  #    operation: add
  #  - what: case
  #    name: _standoffs
  #    operation: add
  #  - what: case
  #    name: _plate_holes
  #    operation: subtract      
